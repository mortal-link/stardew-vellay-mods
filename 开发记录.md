# 钢琴块Mod开发记录

**开发日期：** 2024-12-15
**项目名称：** Piano Block - 星露谷物语音乐方块Mod
**分支：** claude/piano-block-mod-BRTdl

---

## 📋 项目概述

实现了一个可配置的钢琴块mod，允许玩家在星露谷物语中创作音乐。

### 核心功能
- ✅ 可配置音符的方块物品
- ✅ 12个半音 × 8个八度（完整音域）
- ✅ 每个方块支持多个音符序列
- ✅ 可调节曲速（100-2000ms）
- ✅ 直观的游戏内配置界面
- ✅ 可在木匠铺购买或制作

---

## 🗂️ 创建的文件

### 核心代码文件
1. **PianoBlock.csproj** - C#项目配置文件
2. **manifest.json** - SMAPI mod元数据（包含EntryDll配置）
3. **ModEntry.cs** - Mod主入口，处理事件和数据持久化
4. **PianoBlockData.cs** - 数据模型和音符系统
5. **PianoBlockMenu.cs** - 完整的游戏内配置UI

### Content Patcher集成
6. **[CP] Piano Block/manifest.json** - Content Patcher配置
7. **[CP] Piano Block/content.json** - 游戏数据集成（物品、配方、商店）

### 文档和构建工具
8. **README.md** - 完整的中文用户文档
9. **BUILD.md** - 详细的编译指南（多平台）
10. **QUICKSTART.md** - 5分钟快速开始指南
11. **build.sh** - Linux/Mac自动构建脚本
12. **build.bat** - Windows自动构建脚本
13. **.gitignore** - Git忽略规则（包含C#项目标准）
14. **start-game.sh** - 游戏启动辅助脚本

### 桌面快捷方式
15. **启动星露谷(SMAPI).command** - 桌面双击启动器

---

## 🔧 技术实现

### 架构设计
```
ModEntry (主入口)
├── 事件处理
│   ├── ButtonPressed - 检测方块交互
│   ├── SaveLoaded - 加载配置数据
│   ├── Saving - 保存配置数据
│   └── DayStarted - 清理无效数据
├── PianoBlockData - 数据存储
│   └── Dictionary<Vector2, PianoBlockData>
└── PianoBlockMenu - UI界面
    ├── 音符列表编辑
    ├── 音高/八度调整
    ├── 曲速控制
    └── 播放预览
```

### 数据结构
```csharp
PianoBlockData {
    List<MusicNote> Notes         // 音符序列
    int Tempo                      // 曲速 (ms)
    bool Loop                      // 循环播放
    int Volume                     // 音量
}

MusicNote {
    int Pitch (0-11)              // C到B
    int Octave (0-8)              // 八度
    float Duration                // 持续时间
}
```

### Content Patcher数据
- 添加物品到 `Data/Objects`
- 添加配方到 `Data/CraftingRecipes`（10木材 + 1铜锭）
- 添加商店物品到木匠铺（500金币，需要农业3级）

---

## 🚀 编译和安装过程

### 环境配置
- ✅ 检测到 .NET SDK 8.0.402 和 6.0.421
- ✅ 使用 .NET 6.0 目标框架
- ✅ 依赖：Pathoschild.Stardew.ModBuildConfig 4.1.1

### 修复的问题
1. **manifest.json缺少EntryDll字段**
   - 问题：编译时报错"manifest has no EntryDll or ContentPackFor field"
   - 解决：添加 `"EntryDll": "PianoBlock.dll"`

2. **macOS安全限制**
   - 问题：macOS阻止StardewModdingAPI运行
   - 解决：创建了桌面启动器，需要右键"打开"首次授权

### 编译命令
```bash
dotnet restore
dotnet build --configuration Release
```

### 安装位置
```
/Users/wangyan/Library/Application Support/Steam/steamapps/common/Stardew Valley/Contents/MacOS/Mods/
├── PianoBlock/
│   ├── PianoBlock.dll
│   └── manifest.json
└── [CP] Piano Block/
    ├── manifest.json
    └── content.json
```

---

## 📦 依赖关系

### 必需依赖
- **Stardew Valley 1.6+**
- **SMAPI 4.0.0+** ✅ 已安装
- **Content Patcher 2.0.0+** ✅ 已安装

### 可选依赖
- Generic Mod Config Menu（未使用，但在manifest中声明）

---

## 🎮 使用说明

### 获取钢琴块
1. 农业等级达到3级
2. 去罗宾的木匠铺
3. 购买钢琴块（500金币）
   - 或学习配方自己制作

### 配置音乐
1. 放置钢琴块在地图上
2. 右键点击打开配置菜单
3. 使用界面控制：
   - **添加** - 添加新音符
   - **↑/↓** - 调整音高（半音）
   - **8↑/8↓** - 调整八度
   - **X** - 删除音符
   - **曲速按钮** - 调整播放速度
   - **播放** - 预览音乐

### 播放音乐
- 配置完成后，每次右键点击方块即可播放
- 可以放置多个方块组合成完整乐曲

---

## 🔄 Git提交记录

### Commit 1: 实现钢琴块mod
```
实现钢琴块mod - 可配置的音乐方块系统

特性:
- 支持12个半音 × 8个八度的完整音域
- 每个方块可配置多个音符序列
- 可调节曲速 (100-2000ms)
- 直观的游戏内配置界面
- Content Patcher集成，可在木匠铺购买或制作
```

### Commit 2: 添加编译指南
```
添加完整的编译指南和自动构建脚本

功能:
- 自动检测.NET SDK
- 自动恢复NuGet包
- 自动编译项目
- 自动查找星露谷Mods目录
- 可选自动安装到游戏
- 支持Windows、Mac和Linux
```

### Commit 3: 修复manifest
```
修复manifest.json - 添加EntryDll字段

- 添加必需的EntryDll字段指向PianoBlock.dll
- 修复编译错误，现在可以成功构建
```

### Commit 4: 更新.gitignore
```
更新.gitignore - 添加C#项目标准忽略规则

添加了：
- 编译输出目录 (bin/, obj/)
- IDE配置文件
- NuGet包缓存
- 其他C#项目标准忽略项
```

---

## 🎯 功能特性详解

### 音符系统
- **音高范围：** C, C#, D, D#, E, F, F#, G, G#, A, A#, B
- **八度范围：** 0-8（9个八度）
- **音符映射：** 使用游戏内置"flute"音效，通过pitch参数调整
- **音高计算公式：** `1200 + (Octave-4)*1200 + Pitch*100`

### 数据持久化
- 使用 `Helper.Data.ReadSaveData()` 和 `WriteSaveData()`
- 数据键：`"piano-blocks-data"`
- 自动清理无效方块（每日检查）

### UI交互
- 继承自 `IClickableMenu`
- 支持鼠标滚轮滚动（最多显示8个音符）
- 实时预览播放
- 使用游戏内置材质和字体

---

## 🐛 已知问题和限制

### 当前限制
1. 音质基于游戏内置音效，比较简单
2. 暂无音量独立控制
3. 暂不支持循环播放
4. 多人模式未测试

### 待改进功能
- [ ] 添加更多音色选择
- [ ] 实现导入/导出音乐序列
- [ ] 添加红石/压力板触发
- [ ] 支持和弦同时播放
- [ ] 添加循环播放模式
- [ ] 优化音符播放时序

---

## 📚 参考资源

### 开发文档
- [SMAPI官方文档](https://smapi.io/)
- [Content Patcher文档](https://github.com/Pathoschild/StardewMods/tree/develop/ContentPatcher)
- [星露谷Mod开发Wiki](https://stardewvalleywiki.com/Modding:Index)

### 项目仓库
- **远程仓库：** github.com:mortal-link/stardew-vellay-mods.git
- **开发分支：** claude/piano-block-mod-BRTdl
- **本地路径：** /Users/wangyan/Desktop/stardew valley mods

---

## ✅ 完成清单

- [x] 设计mod架构
- [x] 实现核心代码
- [x] 创建UI界面
- [x] 集成Content Patcher
- [x] 编写文档
- [x] 创建构建脚本
- [x] 修复编译错误
- [x] 配置git忽略规则
- [x] 创建桌面启动器
- [x] 测试编译流程

---

## 🎵 下一步

### 测试阶段
1. 启动游戏验证mod加载
2. 测试物品获取（商店/配方）
3. 测试配置界面
4. 测试音符播放
5. 测试数据保存/加载

### 可能的扩展
1. 添加音乐模板/预设
2. 实现音乐分享功能
3. 添加可视化编辑器
4. 支持MIDI导入
5. 创建音乐社区

---

## 📝 备注

- 所有代码使用UTF-8编码
- 支持中文界面和描述
- 构建产物已自动部署到游戏Mods目录
- 首次运行需要在macOS中授权StardewModdingAPI

---

**开发者：** Claude (Anthropic)
**项目状态：** ✅ 编译完成，待游戏内测试
**最后更新：** 2024-12-15 20:06
