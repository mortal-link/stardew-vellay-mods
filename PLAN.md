# Stardew Valley 音乐方块 Mod 开发计划

## 项目概述

将音乐方块系统扩展为完整的音乐创作平台，包含两个独立仓库：

### 仓库结构

| 仓库 | 内容 | 发布渠道 |
|------|------|----------|
| `stardew-piano-block` | C# mod + 采样 + 脚本 | NexusMods |
| `midi-to-stardew` | MIDI 解析前端 (React) | Vercel/Netlify |

---

## 当前进度总结

### 已完成

#### Piano Block Mod (C#)
- [x] 基础钢琴块功能
- [x] 85 个钢琴音频采样 (A1-C8)
- [x] 音符配置 UI (音高、八度、时值)
- [x] 踩踏触发播放
- [x] 和弦支持（一个方块多个音符）
- [x] 控制台命令 (`piano_demo`, `piano_import`, `piano_clear`)
- [x] JSON 预设导入功能

#### MIDI 解析前端 (React + TanStack Start)
- [x] 项目初始化 (Vite + Vue3 + TypeScript + Tailwind)
- [x] MIDI 文件上传和解析 (@tonejs/midi)
- [x] 音轨列表显示和选择
- [x] 导出设置（量化精度、和弦检测阈值）
- [x] JSON 导出（下载/复制）
- [x] 播放预览 (Tone.js)
- [x] **迁移到 React + TanStack Start + shadcn/ui**
- [x] **切换到 pnpm 包管理**

### 待完成

#### Part 1: 音乐跑道地图
- [ ] 创建 1000x10 的大地图
- [ ] 音乐厅门票物品
- [ ] 传送逻辑

#### Part 2: 多乐器支持
- [ ] 吉他音频采样
- [ ] 贝斯音频采样
- [ ] AudioManager 多乐器支持
- [ ] 不同乐器的 Block 类型

#### Part 3: 前端增强
- [ ] 钢琴卷帘可视化
- [ ] 存档生成功能

#### Velocity 支持 ✅
- [x] 确定 6 层采样方案
- [x] 采样下载脚本 (Salamander → WAV)
- [x] 180 个采样下载完成 (161MB)
- [x] AudioManager 多力度层 + 动态变调支持
- [x] MusicNote 添加 Velocity 属性
- [x] 前端 Velocity 导出

---

## Part 1: 音乐跑道地图 (独立 Mod)

### 目标
创建一个 1000 格的专用音乐跑道地图，让玩家可以演奏完整的曲目。

### 技术方案
- **独立 Content Patcher 包**: `[CP] Piano Runway`
- **地图规格**: 1000 x 10 tiles
- **入口方式**: 音乐厅门票物品

### 文件结构
```
[CP] Piano Runway/
├── manifest.json
├── content.json
└── assets/
    └── maps/
        └── PianoRunway.tmx
```

### 实现步骤
1. [ ] 创建独立的 Content Patcher manifest
2. [ ] 使用脚本生成 1000x10 的 TMX 地图文件
3. [ ] 在 Data/Locations 注册新位置
4. [ ] 添加"音乐厅门票"物品
5. [ ] 在主 mod 中添加门票使用传送逻辑
6. [ ] 测试地图加载和传送功能

---

## Part 2: 多乐器支持 (扩展现有 Mod)

### 目标
在现有钢琴块基础上，添加吉他、贝斯等乐器方块。

### 乐器列表
| 乐器 | 物品名 | 状态 |
|------|--------|------|
| 钢琴 | PianoBlock | ✅ 已实现 |
| 吉他 | GuitarBlock | ⏳ 待做 |
| 贝斯 | BassBlock | ⏳ 待做 |
| 电吉他 | ElectricGuitarBlock | ⏳ 待做 |
| 小提琴 | ViolinBlock | ⏳ 待做 |
| 鼓 | DrumBlock | ⏳ 待做 |

### 技术方案
- **音频来源**: tonejs-instruments (开源采样库)
- **代码重构**: AudioManager 支持多乐器加载
- **物品定义**: 每种乐器一个独立的 Block 类型

### 数据结构
```csharp
// 不同乐器使用不同的 Block 类型
// PianoBlock, GuitarBlock, BassBlock 等
// 每种 Block 加载对应的音频采样
```

---

## Part 3: MIDI 解析前端

### 当前功能
| 功能 | 状态 |
|------|------|
| MIDI 上传解析 | ✅ 完成 |
| 音轨选择 | ✅ 完成 |
| 导出设置 | ✅ 完成 |
| JSON 导出 | ✅ 完成 |
| 播放预览 | ✅ 完成 |
| 钢琴卷帘/瀑布流可视化 | ⏳ 待做 (用 html-midi-player) |
| Velocity 导出 | ✅ 完成 |
| **简谱生成** | ⏳ 待做 |
| 存档生成 | ⏳ 待做 |

### JSON 导出格式
```json
{
  "Name": "曲目名称",
  "Blocks": [
    {
      "Notes": [
        { "Note": "C4", "Duration": 500, "Velocity": 80 },
        { "Note": "E4", "Duration": 500, "Velocity": 100 }
      ]
    }
  ]
}
```

### 技术栈
- ~~Vue 3 + TypeScript~~ → **React + TanStack Start**
- ~~Vite~~ → TanStack Start (内置 Vite)
- **pnpm** 包管理
- Tailwind CSS v4
- **shadcn/ui** 组件库
- @tonejs/midi (MIDI 解析)
- Tone.js (音频播放)
- ~~Pinia~~ → **Zustand** 状态管理

---

## 开发优先级

```
Phase 1 ✅ 完成
└── Part 3: MIDI 解析前端 MVP

Phase 2 (下一步)
├── Part 1: 音乐跑道地图
└── Part 2: 多乐器支持 (吉他、贝斯)

Phase 3 (后续)
├── Part 3: 钢琴卷帘可视化
├── Part 3: 简谱生成 (数字谱 + 节拍 + 时值)
└── Part 3: 存档生成功能
```

---

## 已确定技术决策

### Velocity（力度）实现方案 ✅ 已确定

采用 **6 层多重采样**方案：

| 层级 | Velocity 范围 | 演奏力度 | 来源 (Salamander) |
|------|--------------|----------|-------------------|
| 1 | 0-21 | pp (极弱) | v1 |
| 2 | 22-42 | p (弱) | v4 |
| 3 | 43-63 | mp (中弱) | v7 |
| 4 | 64-84 | mf (中强) | v10 |
| 5 | 85-105 | f (强) | v13 |
| 6 | 106-127 | ff (极强) | v16 |

**技术细节：**
- 采样来源: [Salamander Grand Piano](https://github.com/sfzinstruments/SalamanderGrandPiano) (CC0 授权)
- 原始力度层: 16 层，我们精选 6 层
- 音符覆盖: A0-C8，小三度间隔 (30 个音高)
- 每个采样: 5 秒 WAV
- 总文件数: 180 个 (30 音高 × 6 力度层)
- 实际大小: 161MB

**动态音高变调：**
- 30 个采样点，每个 ±1 半音 = 90 音覆盖 > 88 键
- 最大变调 ±1 半音
- 音质损失极小，人耳几乎无法分辨

**文件命名规范：**
```
assets/piano-velocity/
├── A0_v1.wav  (pp)
├── A0_v2.wav  (p)
├── A0_v3.wav  (mp)
├── A0_v4.wav  (mf)
├── A0_v5.wav  (f)
├── A0_v6.wav  (ff)
├── C1_v1.wav
├── ...
└── C8_v6.wav
```

### 乐器优先级 ✅ 已确定
吉他 → 贝斯 → 鼓

### 音乐块增强功能 (待实现)

**1. 多轨道同步触发**
- 新增 `TrackGroup` 属性（轨道组名）
- 同一 X 坐标的不同轨道方块同时触发
- 用途：钢琴和鼓分开放置，但同步播放

```
═══════════════════  ← 钢琴轨道 (Y=10)
🎹 🎹 🎹 🎹 🎹

═══════════════════  ← 鼓轨道 (Y=15)
🥁 🥁 🥁 🥁 🥁
        ↑
    玩家踩这里，两轨同时触发
```

**2. 触发半径**
- 新增 `TriggerRadius` 属性（默认 1 格）
- 玩家在半径内即可触发，不用精确踩中
- 用途：降低操作难度，适合快节奏曲目

**3. 工具拾取**
- 用锄头/镐敲击音乐块 → 变回物品掉落
- 重新放置到新位置
- 类似游戏内箱子的标准行为

### 简谱生成功能 (待实现)

**目标**: MIDI 转完整数字简谱，可打印/分享

**简谱元素：**
- 数字 1-7（do re mi fa sol la si）
- 高八度点（数字上方）、低八度点（数字下方）
- 升降号（#、b）
- 时值：下划线（八分/十六分）、附点（增时一半）
- 小节线
- 连音线
- 休止符（0）

**技术方案：**
- SVG 渲染（便于打印和导出）
- 自动排版（每行固定小节数）
- 调号检测和显示

**优先级**: 低（Phase 3）

### 钢琴卷帘/瀑布流可视化 (待实现)

**目标**: MIDI 可视化预览，类似"别踩白块"效果

**技术方案**: 集成 [html-midi-player](https://github.com/cifkao/html-midi-player)
- Web Component，可嵌入 Vue
- 支持 MIDI 解析和瀑布流渲染
- MIT 开源

**优先级**: 低（Phase 3）

### 节奏辅助功能 (待实现)

**1. 节拍线提示**
- 屏幕 HUD 显示当前节拍（1-2-3-4）
- 下一个要踩的方块闪烁提示
- 可选：节拍器音效（嘀嗒声）
- 配置项：开关、提前量、视觉样式

**2. BPM 与方块间距**
- 前端根据 MIDI 的 BPM 计算方块放置间距
- BPM 快 → 间距小，BPM 慢 → 间距大
- 玩家正常速度行走即可匹配节奏
- 可选：玩家速度倍率调整

### 音效增强功能 (待实现)

**1. 延音效果 (Sustain)** - 优先级：中
- 在 MusicNote 中添加 `Sustain` 属性
- 设置为 true 时，音符持续发声直到下一个音符
- 玩家正常经过方块，无需特殊操作
- 用途：模拟钢琴踏板效果

**2. 混响效果 (Reverb)** - 优先级：中
- 提供干声/湿声两套采样（或可选混响预设）
- 玩家可在设置中选择空间感
- 预设：无混响 / 小房间 / 音乐厅 / 教堂

**3. 音量渐变 (Dynamics)** - 优先级：低
- MusicNote 新增 `TargetVelocity` 属性
- 解析 MIDI CC7/CC11 事件实现渐强渐弱
- 视觉反馈：方块颜色深浅变化

### 存档编辑器 (最终目标)

**产品愿景**: 完整的 Stardew Valley 音乐编辑器

**核心流程**:
```
存档导入 → 地图编辑器 → 音符编辑器 → 存档导出
```

**功能模块**:
| 模块 | 功能 | 复杂度 |
|------|------|--------|
| 存档解析 | 读取 XML 存档，提取钢琴块数据 | 中 |
| 地图视图 | 显示农场/地图，可视化钢琴块位置 | 高 |
| MIDI 导入 | 解析 MIDI → 自动生成钢琴块布局 | ✅ 已完成 |
| 瀑布流预览 | 可视化音符时间线 | 中 |
| 简谱视图 | 数字简谱显示 | 中 |
| 钢琴键盘 | 手动弹奏测试 | 低 |
| 存档导出 | 写回 XML，保持格式兼容 | 中 |

**开发顺序**:
```
Phase A: 存档读写基础
├── 解析存档 XML
├── 提取钢琴块数据
└── 写回存档（保持格式）

Phase B: 编辑功能
├── 钢琴块列表管理（增删改）
├── MIDI → 钢琴块转换（已有）
└── 简单坐标编辑

Phase C: 可视化增强
├── 瀑布流预览
├── 简谱视图
└── 地图可视化（可选）

Phase D: 高级功能
├── 钢琴键盘手动弹奏
├── 多乐器支持
└── 跑道地图集成
```

**优先级**: Phase 4（最终目标）

---

## 备注

- 所有音频采样需确保版权合规（使用开源/CC0 授权）
- MIDI 解析需考虑复杂曲目的性能优化
- 存档修改功能需要谨慎，建议自动备份
